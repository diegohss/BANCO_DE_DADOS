use havik
go
/*
Todas os Projetos em Aberto onde o Henry é o Responsavel da Entrega
- Cod Projeto
- Nome Projeto
- Consultor (Colab. Responsavel)
- Dt Criação Projeto
- Dias em Aberto
- Candidatos linkados a vaga (count ou todos)
- Candidatos Enviados (short list enviado ... count ou todos) (3-18)

Email e Nome de todos com ddd 21 e classificamos como Segmento - Banking / Area - Comercial
*/
use havik
go
select base.id id_projeto,
	   base.nome projeto,
	   rent.nome_usuario resp_entrega,
	   col.nome_usuario colab_responsavel,
	   rcap.nome_usuario resp_captacao,
	   base.cod_do_vagas,
	   base.requisicao_vagas,
	   convert(char(10),base.dt_criacao,23) data_criacao,
	   DATEDIFF(day,base.dt_criacao,getdate()) dias_em_aberto,
	   proj.qtd_clientes linkados_vaga,
	   COUNT(st.id_cliente) candidatos_enviados  
	   	
from bc_projeto base

left join (select id_projeto, count(id_cliente) qtd_clientes from bh_cli_projeto 
		   group by id_projeto)proj on
	proj.id_projeto=base.id
	
left join (select id_projeto,id_cliente from bh_cli_status st where
	st.id_status=3 and
	st.id_substatus=18 and
	st.exibir=1	
	group by id_projeto,id_cliente)st on
	st.id_projeto=base.id
	
left join bc_usuario rent on
	rent.id=base.responsavel_entrega
	
left join bc_usuario col on
	col.id=base.colaborador_responsavel
	
left join bc_usuario rcap on
	rcap.id=base.responsavel_captacao		
	
left join br_tp_produto prod on
	prod.id=base.tipo_produto	
	
where base.responsavel_captacao=3 and base.dt_fim is null
/*and
(
convert(char(10),base.dt_ini,23)>='2012-05-15'*/
/*or
base.id in
(
1741,
1742,
1773,
1774,
1775,
1776,
1777,
1802,
1803,
1194,
1357,
1366,
1367,
1368,
1409,
1474,
1492,
1493,
1497,
1499,
1505,
1528,
1534,
1535,
1536,
1561,
1562,
1570,
1598,
1631,
1632,
1633,
1634,
1641,
1642,
1643,
1649,
1690,
1702,
1703,
1728,
1750,
1751,
1752,
1753,
1754,
1763,
1766,
1780,
1790,
1664,
1676,
1677,
1711,
1712,
1714,
1720,
1734,
1735,
1736,
1737,
1759,
1767,
1768,
1769,
1770,
1771,
1772,
1824,
1118,
1177,
1226,
1229,
1391,
1464,
1489,
1492,
1493,
1508,
1509,
1595,
1597,
1600,
1610,
1617,
1625,
1626,
1627,
1628,
1629,
1645,
1682,
1686,
1709,
1729,
1730,
1738,
1739,
1740,
1755,
1756,
1758,
1778,
1779,
1781,
1782,
1783,
1784,
1801,
1825,
1826,
198,
404,
421,
435,
440,
441,
442,
457,
458,
465,
467,
476,
497,
500,
516,
576,
578,
589,
593,
594,
608,
617,
621,
689,
690,
691,
692,
699,
700,
701,
705,
717,
720,
721,
760,
762,
781,
788,
789,
792,
793,
795,
799,
800,
803,
804,
805,
815,
859,
861,
862,
863,
864,
865,
867,
868,
914,
915,
920,
921,
925,
933,
934,
935,
939,
944,
946,
1033,
1069,
1073,
1078,
1079,
1080,
1082,
1092,
1096,
1098,
1099,
1102,
1117,
1143,
1178,
1179,
1180,
1181,
1188,
1192,
1197,
1222,
1223,
1224,
1268,
1271,
1272,
1274,
1289,
1299,
1314,
1323,
1324,
1326,
1327,
1344,
1346,
1348,
1399,
1519,
1520,
1525,
1526,
1553,
1560,
1636,
1691,
1695,
1698
)*/
--)
group by 
	   base.id,
	   base.nome,
	   rent.nome_usuario,
	   col.nome_usuario,
	   rcap.nome_usuario,
	   base.cod_do_vagas,
	   base.requisicao_vagas,
	   base.dt_criacao,
	   proj.qtd_clientes